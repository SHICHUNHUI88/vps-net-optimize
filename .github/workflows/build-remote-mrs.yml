name: Remote Rules -> remote-mrs (sing-box)

on:
  workflow_dispatch:
  schedule:
    - cron: "10 4 * * *"   # UTC 04:10 = åŒ—äº¬æ—¶é—´ 12:10ï¼ˆé¿å¼€ä½ æ—§ä»»åŠ¡ï¼‰

  push:
    branches: [ "main", "master" ]
    paths:
      - "remote-rules.json"
      - "scripts/Diversion_Conversion.py"
      - ".github/workflows/remote-rules-to-mrs.yml"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Install sing-box
        run: |
          set -eux
          SB_VER="1.11.0"
          curl -L -o sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/v${SB_VER}/sing-box-${SB_VER}-linux-amd64.tar.gz"
          tar -xzf sing-box.tar.gz
          mv "sing-box-${SB_VER}-linux-amd64/sing-box" ./sing-box
          chmod +x ./sing-box
          ./sing-box version

      # ğŸ” å¼ºåˆ¶æ‰“å°ï¼šè®©ä½ ä¸€çœ¼çœ‹å‡ºæ˜¯å¦æ‰¾å¾—åˆ°æ¸…å•ã€è„šæœ¬ã€è¾“å‡ºç›®å½•
      - name: Precheck files
        run: |
          set -eux
          echo "=== PWD ==="
          pwd
          echo "=== LIST ROOT ==="
          ls -la
          echo "=== LIST .github/workflows ==="
          ls -la .github/workflows || true
          echo "=== SHOW remote-rules.json ==="
          cat remote-rules.json

      - name: Build remote-mrs
        env:
          SINGBOX_BIN: ./sing-box
        run: |
          set -eux
          python scripts/Diversion_Conversion.py
          echo "=== LIST remote-src ==="
          ls -la remote-src || true
          echo "=== LIST remote-mrs ==="
          ls -la remote-mrs || true

      - name: Commit & Push
        run: |
          set -eux
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # åªæäº¤éš”ç¦»ç›®å½•ï¼ˆä¸ç¢°ä½ æ—§ç›®å½•ï¼‰
          git add remote-mrs remote-src remote-rules.json || true

          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git commit -m "chore: update remote-mrs $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push