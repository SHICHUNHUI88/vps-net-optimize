name: Build douyin.mrs

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Download mihomo
        shell: bash
        run: |
          set -euo pipefail

          # GitHub Runner æ˜¯ amd64ï¼Œè¿™é‡Œç›´æ¥ç”¨ amd64 ç‰ˆæœ¬
          MIHOMO_VERSION="1.19.10"
          ASSET="mihomo-linux-amd64-v${MIHOMO_VERSION}.gz"
          URL="https://github.com/MetaCubeX/mihomo/releases/download/v${MIHOMO_VERSION}/${ASSET}"

          echo "ğŸ“¥ Downloading: ${URL}"
          wget -O mihomo.gz "${URL}"

          # è§£å‹ gzï¼Œå¾—åˆ° mihomo-linux-amd64-v1.19.10
          gzip -d -f mihomo.gz

          # ç›´æ¥é‡å‘½åä¸º mihomoï¼ˆæ³¨æ„ï¼Œè¿™é‡Œä¸å†åšä»€ä¹ˆ before/after æ£€æµ‹ï¼‰
          mv "mihomo-linux-amd64-v${MIHOMO_VERSION}" mihomo

          chmod +x mihomo

          echo "âœ… mihomo version:"
          ./mihomo -v

      - name: Convert douyin.yaml -> douyin.mrs
        shell: bash
        run: |
          set -euo pipefail

          # ç¡®ä¿æºæ–‡ä»¶å­˜åœ¨
          if [ ! -f "ruleset-src/douyin.yaml" ]; then
            echo "âŒ æ‰¾ä¸åˆ° ruleset-src/douyin.yaml"
            exit 1
          fi

          mkdir -p ruleset-mrs

          echo "ğŸ”„ å¼€å§‹è½¬æ¢ douyin.yaml -> douyin.mrs (domain æ¨¡å¼)"
          ./mihomo convert-ruleset domain yaml ruleset-src/douyin.yaml ruleset-mrs/douyin.mrs

          if [ ! -s "ruleset-mrs/douyin.mrs" ]; then
            echo "âŒ è½¬æ¢å¤±è´¥ï¼šruleset-mrs/douyin.mrs ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
            exit 1
          fi

          ls -lh ruleset-mrs/douyin.mrs

      - name: Commit douyin.mrs
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # å¦‚æœæ²¡æœ‰å˜åŒ–å°±ä¸æäº¤
          if git status --porcelain | grep -q "ruleset-mrs/douyin.mrs"; then
            echo "ğŸ“¤ æäº¤ douyin.mrs..."
            git add ruleset-mrs/douyin.mrs
            git commit -m "build: update douyin.mrs" || exit 0
            git push
            echo "âœ… æ¨é€æˆåŠŸ"
          else
            echo "âœ… æ²¡æœ‰æ–°çš„å˜æ›´ï¼Œæ— éœ€æäº¤"
          fi