name: build-mrs

on:
  push:
    paths:
      - "ruleset-src/**.yaml"
      - ".github/workflows/build-mrs.yml"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download mihomo
        shell: bash
        run: |
          set -euo pipefail
          API_URL="https://api.github.com/repos/MetaCubeX/mihomo/releases/latest"
          echo "Fetching latest release info from $API_URL ..."
          DOWNLOAD_URL=$(curl -s -H "Accept: application/vnd.github.v3+json" "$API_URL" | \
            grep -E '"browser_download_url":.*linux-amd64.*\.(gz|tar\.gz)"' | \
            head -1 | sed -E 's/.*"([^"]+)".*/\1/')
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "âŒ æœªæ‰¾åˆ°åŒ¹é…çš„ assetï¼Œå½“å‰ release ä¸­çš„å®é™… asset åç§°å¦‚ä¸‹ï¼š"
            curl -s "$API_URL" | grep '"name":' || echo "æ— æ³•è·å– asset åˆ—è¡¨"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°ä¸‹è½½é“¾æ¥: $DOWNLOAD_URL"
          curl -fL --retry 3 --retry-delay 2 -o mihomo.pkg "$DOWNLOAD_URL"
          SIZE=$(stat -c%s mihomo.pkg)
          echo "ä¸‹è½½å¤§å°: $SIZE bytes"
          if [ "$SIZE" -lt 1000000 ]; then
            echo "âŒ æ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„äºŒè¿›åˆ¶åŒ…"
            head -c 200 mihomo.pkg || true
            exit 1
          fi
          if [[ "$DOWNLOAD_URL" =~ \.tar\.gz$ ]]; then
            tar -xzf mihomo.pkg
          else
            mv mihomo.pkg mihomo.gz
            gunzip -f mihomo.gz
          fi
          chmod +x mihomo
          ./mihomo -v

      - name: Get changed YAML files
        id: changed-files
        run: |
          set -eux
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            CHANGED=$(git diff --name-only --diff-filter=ACMR HEAD~ HEAD -- ruleset-src/ '*.yaml' || true)
          else
            CHANGED=$(git diff --name-only --diff-filter=ACMR ${{ github.event.before }} ${{ github.event.after }} -- ruleset-src/ '*.yaml' || true)
          fi
          echo "changed=$(echo "$CHANGED" | jq -R -s -c 'split("\n") | map(select(length > 0))')" >> $GITHUB_OUTPUT

      - name: Build mrs
        run: |
          set -eux
          mkdir -p ruleset
          echo '${{ steps.changed-files.outputs.changed }}' | jq -r '.[]' | while read -r yaml_file; do
            if [ -f "$yaml_file" ]; then
              base=$(basename "$yaml_file" .yaml)
              output="ruleset/${base}.mrs"
              echo "ğŸ”¨ æ„å»º $yaml_file -> $output"
              ./mihomo convert-ruleset domain yaml "$yaml_file" "$output"
            else
              echo "âš ï¸ æ–‡ä»¶ $yaml_file ä¸å­˜åœ¨ï¼Œè·³è¿‡"
            fi
          done

      - name: Commit & push
        run: |
          set -eux
          # åˆ é™¤ä¸‹è½½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé¿å…å¹²æ‰°æäº¤
          rm -f mihomo
          if git status --porcelain | grep -q .; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add ruleset/
            git commit -m "build: update MRS files"
            git push
          else
            echo "âœ… æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          fi
