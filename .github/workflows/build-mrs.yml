name: build-mrs

on:
  push:
    branches: [ "main" ]
    paths:
      - "ruleset-src/douyin.yaml"
      - ".github/workflows/build-mrs.yml"
  workflow_dispatch: {}
  schedule:
    - cron: "0 4 * * *"   # UTC 04:00 = 北京时间 12:00

env:
  TZ: Asia/Shanghai
  TOOLS_DIR: data/tools
  OUT_DIR: ruleset
  SRC_FILE: ruleset-src/douyin.yaml

permissions:
  contents: write

jobs:
  build:
    name: Build & Commit douyin.mrs
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set timezone
        run: |
          set -eux
          sudo timedatectl set-timezone "$TZ" || true
          date

      - name: Install dependencies
        run: |
          set -eux
          sudo apt-get update -y
          sudo apt-get install -y curl jq gzip tar

      - name: Create tools directory
        run: |
          set -eux
          mkdir -p "${TOOLS_DIR}"
          echo "✓ Tools dir: ${TOOLS_DIR}"

      - name: Check if mihomo exists
        id: check_tools
        run: |
          set -eux
          if [ -f "${TOOLS_DIR}/mihomo" ]; then
            echo "mihomo_exist=true" >> $GITHUB_OUTPUT
            echo "✓ mihomo already exists"
            "${TOOLS_DIR}/mihomo" -v || true
          else
            echo "mihomo_exist=false" >> $GITHUB_OUTPUT
            echo "ℹ️ mihomo not found, will download"
          fi

      - name: Download mihomo (robust)
        if: steps.check_tools.outputs.mihomo_exist == 'false'
        shell: bash
        run: |
          set -euxo pipefail
          cd "${TOOLS_DIR}"

          api="https://api.github.com/repos/MetaCubeX/mihomo/releases/latest"

          echo "Fetching latest assets list..."
          curl -fsSL "$api" | jq -r '.assets[].name' | sed 's/^/ - /'

          url="$(curl -fsSL "$api" | jq -r '
            .assets[]
            | select(.name | test("linux-amd64"))
            | select(.name | test("\\.(gz|tar\\.gz)$"))
            | .browser_download_url
          ' | head -n 1)"

          echo "Download URL: ${url:-}"
          if [ -z "${url:-}" ]; then
            echo "❌ No linux-amd64 asset found."
            exit 1
          fi

          curl -fL --retry 3 --retry-delay 2 -o mihomo.pkg "$url"

          size="$(stat -c%s mihomo.pkg)"
          echo "Downloaded size: $size"
          if [ "$size" -lt 1000000 ]; then
            echo "❌ File too small, likely not a binary. First 200 bytes:"
            head -c 200 mihomo.pkg || true
            exit 1
          fi

          if echo "$url" | grep -qE '\.tar\.gz$'; then
            tar -xzf mihomo.pkg
          else
            mv mihomo.pkg mihomo.gz
            gzip -t mihomo.gz
            gzip -d -f mihomo.gz
          fi

          bin="$(find . -maxdepth 2 -type f -name 'mihomo*' -size +5M | head -n 1)"
          echo "Detected binary: ${bin:-}"
          if [ -z "${bin:-}" ]; then
            echo "❌ Cannot find mihomo binary after extract."
            ls -lah
            exit 1
          fi

          cp -f "$bin" mihomo
          chmod +x mihomo
          ./mihomo -v
          rm -f mihomo.pkg mihomo.gz || true
          echo "✓ mihomo ready in ${TOOLS_DIR}/mihomo"

      - name: Sanity check source file
        run: |
          set -eux
          test -f "${SRC_FILE}"
          echo "✓ Source exists: ${SRC_FILE}"
          head -n 20 "${SRC_FILE}" || true

      - name: Build douyin.mrs
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p "${OUT_DIR}"

          "${TOOLS_DIR}/mihomo" convert-ruleset domain yaml "${SRC_FILE}" "${OUT_DIR}/douyin.mrs"

          echo "✓ Output:"
          ls -lah "${OUT_DIR}/douyin.mrs"

      - name: Check for changes
        id: check_changes
        shell: bash
        run: |
          set -euxo pipefail
          git add "${OUT_DIR}/douyin.mrs"

          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ℹ️ No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "✓ Changes detected"
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -euxo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "build: update douyin.mrs $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push
          echo "✓ Pushed"
