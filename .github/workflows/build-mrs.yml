name: Build MRS Rules (domain & ip only) with daily schedule

on:
  schedule:
    - cron: '0 4 * * *'      # 每天 UTC 4:00 (北京时间 12:00) 运行
  push:
    branches: [ "main" ]
    paths:
      - "ruleset-src/**.yaml"
      - ".github/workflows/build-mrs.yml"
  workflow_dispatch: {}       # 允许手动触发

env:
  MIHOMO_VERSION: 1.19.10      # 可根据需要修改版本
  SRC_DIR: ruleset-src          # 源文件和输出文件共用目录

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 下载指定版本的 mihomo（固定版本，避免动态解析失败）
      - name: Download mihomo (fixed version)
        run: |
          set -eux
          wget -O mihomo.gz "https://github.com/MetaCubeX/mihomo/releases/download/v${MIHOMO_VERSION}/mihomo-linux-amd64-v${MIHOMO_VERSION}.gz"
          gzip -d mihomo.gz
          # 解压后可能得到带版本号的文件，统一重命名为 mihomo
          if [ -f "mihomo-linux-amd64-v${MIHOMO_VERSION}" ]; then
            mv "mihomo-linux-amd64-v${MIHOMO_VERSION}" mihomo
          elif [ ! -f "mihomo" ]; then
            echo "Error: mihomo binary not found"
            exit 1
          fi
          chmod +x mihomo
          ./mihomo -v

      # 设置 Python 环境（用于运行提取脚本）
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install PyYAML
        run: pip install pyyaml

      # 构建步骤：提取域名和 IP 规则，分别生成 _domain.mrs 和 _ip.mrs
      - name: Build MRS for domain and IP rules only
        run: |
          set -eux
          # 清理旧的 .mrs 文件（避免残留）
          rm -f ${SRC_DIR}/*.mrs

          for yaml in ${SRC_DIR}/*.yaml; do
            [ -f "$yaml" ] || continue
            base=$(basename "$yaml" .yaml)

            # 使用 Python 脚本提取规则并转换
            python3 - <<EOF
import yaml
import os

yaml_file = "$yaml"
base_name = "$base"
src_dir = "${SRC_DIR}"

with open(yaml_file, 'r', encoding='utf-8') as f:
    data = yaml.safe_load(f)

domain_rules = []
ip_rules = []

if data and 'payload' in data:
    for item in data['payload']:
        if isinstance(item, str):
            # 提取域名规则：以 DOMAIN 开头（排除 DOMAIN-REGEX）
            if item.startswith('DOMAIN') and not item.startswith('DOMAIN-REGEX'):
                domain_rules.append(item)
            # 提取 IP 规则：以 IP-CIDR 或 IP-CIDR6 开头
            elif item.startswith('IP-CIDR'):
                ip_rules.append(item)

# 转换域名规则（如果有）
if domain_rules:
    temp_domain = f"{src_dir}/temp_domain_{base_name}.yaml"
    with open(temp_domain, 'w') as f:
        f.write("payload:\n")
        for rule in domain_rules:
            f.write(f"  - {rule}\n")
    os.system(f"./mihomo convert-ruleset domain yaml {temp_domain} {src_dir}/{base_name}_domain.mrs")
    os.remove(temp_domain)
    print(f"✓ Converted domain rules: {base_name}_domain.mrs")
else:
    print(f"ℹ️ No domain rules in {base_name}.yaml")

# 转换 IP 规则（如果有）
if ip_rules:
    temp_ip = f"{src_dir}/temp_ip_{base_name}.yaml"
    with open(temp_ip, 'w') as f:
        f.write("payload:\n")
        for rule in ip_rules:
            f.write(f"  - {rule}\n")
    os.system(f"./mihomo convert-ruleset ipcidr yaml {temp_ip} {src_dir}/{base_name}_ip.mrs")
    os.remove(temp_ip)
    print(f"✓ Converted IP rules: {base_name}_ip.mrs")
else:
    print(f"ℹ️ No IP rules in {base_name}.yaml")
EOF
          done

          # 删除 mihomo 二进制，避免被 git 跟踪
          rm -f mihomo

      # 提交并推送生成的 .mrs 文件（原 YAML 保持不变）
      - name: Commit and push changes
        run: |
          set -eux
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add ${SRC_DIR}/
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "build: update MRS files in ${SRC_DIR} $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push