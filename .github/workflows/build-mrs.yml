name: build-mrs

on:
  push:
    paths:
      - "ruleset-src/**.yaml"
      - ".github/workflows/build-mrs.yml"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------
      # Download mihomo -> /tmp/mihomo
      # -------------------------
      - name: Download mihomo
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

          API="https://api.github.com/repos/MetaCubeX/mihomo/releases/latest"

          echo "Assets list:"
          curl -fsSL "$API" | jq -r '.assets[].name' | sed 's/^/ - /'

          URL="$(curl -fsSL "$API" | jq -r '
            .assets[]
            | select(.name | test("linux"; "i"))
            | select(.name | test("(amd64|x86_64)"; "i"))
            | select(.name | test("\\.(gz|tar\\.gz)$"; "i"))
            | .browser_download_url
          ' | head -n 1)"

          echo "Chosen URL: $URL"
          test -n "$URL"

          curl -fL --retry 3 --retry-delay 2 -o /tmp/mihomo.pkg "$URL"

          cd /tmp
          if echo "$URL" | grep -qiE '\.tar\.gz$'; then
            tar -xzf /tmp/mihomo.pkg
          else
            mv /tmp/mihomo.pkg /tmp/mihomo.gz
            gunzip -f /tmp/mihomo.gz
          fi

          chmod +x /tmp/mihomo
          /tmp/mihomo -v

      # -------------------------
      # Find changed yaml files in this push
      # -------------------------
      - name: Get changed YAML files
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.event.after }}"

          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            CHANGED="$(git diff --name-only --diff-filter=ACMR HEAD~1 HEAD -- 'ruleset-src/' '*.yaml' || true)"
          else
            CHANGED="$(git diff --name-only --diff-filter=ACMR "$BEFORE" "$AFTER" -- 'ruleset-src/' '*.yaml' || true)"
          fi

          echo "Changed files:"
          echo "$CHANGED"

          # output as newline list
          {
            echo "files<<EOF"
            echo "$CHANGED"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # -------------------------
      # Build mrs for each changed yaml
      # -------------------------
      - name: Build mrs
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ruleset

          # å¦‚æžœè¿™æ¬¡ push æ²¡æ”¹ yamlï¼Œå°±ç›´æŽ¥è·³è¿‡
          if [ -z "${{ steps.changed.outputs.files }}" ]; then
            echo "âœ… æ²¡æœ‰å˜æ›´çš„ YAMLï¼Œè·³è¿‡æž„å»º"
            exit 0
          fi

          while IFS= read -r yaml_file; do
            [ -z "$yaml_file" ] && continue
            if [ -f "$yaml_file" ]; then
              base="$(basename "$yaml_file" .yaml)"
              out="ruleset/${base}.mrs"
              echo "ðŸ”¨ $yaml_file -> $out"
              /tmp/mihomo convert-ruleset domain yaml "$yaml_file" "$out"
            fi
          done <<< "${{ steps.changed.outputs.files }}"

      # -------------------------
      # Commit only if ruleset/ changed
      # -------------------------
      - name: Commit & push
        shell: bash
        run: |
          set -euo pipefail

          git add ruleset/

          if git diff --cached --quiet; then
            echo "âœ… ruleset/ æ²¡æœ‰å˜åŒ–ï¼Œæ— éœ€æäº¤"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "build: update MRS files"
          git push
