name: build-mrs

on:
  push:
    paths:
      - "ruleset-src/**.yaml"
      - ".github/workflows/build-mrs.yml"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # Download mihomo (auto-detect linux-amd64 asset from latest release)
      # ------------------------------------------------------------
      - name: Download mihomo
        shell: bash
        run: |
          set -euo pipefail

          API_URL="https://api.github.com/repos/MetaCubeX/mihomo/releases/latest"
          echo "Fetching latest release info from $API_URL ..."

          # Use python to parse JSON (no jq dependency)
          DOWNLOAD_URL="$(python3 - <<'PY'
import json, re, urllib.request

api = "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest"
req = urllib.request.Request(api, headers={"User-Agent": "github-actions"})
data = json.load(urllib.request.urlopen(req))

pat = re.compile(r"mihomo-linux-amd64\.(tar\.gz|gz)$")
for a in data.get("assets", []):
    name = a.get("name", "")
    if pat.search(name):
        print(a.get("browser_download_url", ""))
        break
PY
)"

          if [ -z "$DOWNLOAD_URL" ]; then
            echo "‚ùå Êú™ÊâæÂà∞ÂåπÈÖçÁöÑ assetÔºàmihomo-linux-amd64.gz Êàñ .tar.gzÔºâ„ÄÇ"
            echo "ÂΩìÂâç release assetsÔºö"
            curl -s "$API_URL" | grep '"name":' || true
            exit 1
          fi

          echo "‚úÖ ‰∏ãËΩΩÈìæÊé•: $DOWNLOAD_URL"

          # Download (fail fast on 404)
          curl -fL --retry 3 --retry-delay 2 -o /tmp/mihomo.pkg "$DOWNLOAD_URL"

          # Basic sanity check: too small = likely error page
          SIZE=$(stat -c%s /tmp/mihomo.pkg)
          echo "‰∏ãËΩΩÂ§ßÂ∞è: $SIZE bytes"
          if [ "$SIZE" -lt 1000000 ]; then
            echo "‚ùå Êñá‰ª∂Â§™Â∞èÔºåÂèØËÉΩ‰∏çÊòØÊúâÊïà‰∫åËøõÂà∂ÂåÖÔºåÂÜÖÂÆπÈ¢ÑËßàÔºö"
            head -c 200 /tmp/mihomo.pkg || true
            exit 1
          fi

          # Extract to /tmp/mihomo (avoid untracked file in repo)
          cd /tmp
          if [[ "$DOWNLOAD_URL" =~ \.tar\.gz$ ]]; then
            tar -xzf /tmp/mihomo.pkg
          else
            mv /tmp/mihomo.pkg /tmp/mihomo.gz
            gunzip -f /tmp/mihomo.gz
          fi

          chmod +x /tmp/mihomo
          /tmp/mihomo -v

      # ------------------------------------------------------------
      # Get changed YAML files in this push
      # Output: JSON array in steps.changed-files.outputs.changed
      # ------------------------------------------------------------
      - name: Get changed YAML files
        id: changed-files
        shell: bash
        run: |
          set -euo pipefail

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.event.after }}"

          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            # First push on new branch: compare HEAD~1..HEAD if possible
            CHANGED="$(git diff --name-only --diff-filter=ACMR HEAD~1 HEAD -- 'ruleset-src/' '*.yaml' || true)"
          else
            CHANGED="$(git diff --name-only --diff-filter=ACMR "$BEFORE" "$AFTER" -- 'ruleset-src/' '*.yaml' || true)"
          fi

          echo "Changed YAML files:"
          echo "$CHANGED"

          # Convert newline-separated list to JSON array without jq
          JSON="$(python3 - <<'PY'
import os, json
changed = os.environ.get("CHANGED","").splitlines()
changed = [x.strip() for x in changed if x.strip()]
print(json.dumps(changed, ensure_ascii=False))
PY
)"
          echo "changed=$JSON" >> "$GITHUB_OUTPUT"
        env:
          CHANGED: ${{ steps.changed-files.outputs.changed }}

      # ------------------------------------------------------------
      # Build .mrs for each changed YAML
      # ------------------------------------------------------------
      - name: Build mrs
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ruleset

          JSON='${{ steps.changed-files.outputs.changed }}'

          # Iterate JSON array with python (no jq)
          python3 - <<'PY'
import json, os, subprocess, pathlib

json_text = os.environ["JSON"]
files = json.loads(json_text) if json_text else []
mihomo = "/tmp/mihomo"

if not files:
    print("‚úÖ Ê≤°ÊúâÂèòÊõ¥ÁöÑ YAMLÔºåË∑≥ËøáÊûÑÂª∫")
    raise SystemExit(0)

pathlib.Path("ruleset").mkdir(parents=True, exist_ok=True)

for yaml_file in files:
    p = pathlib.Path(yaml_file)
    if not p.exists():
        print(f"‚ö†Ô∏è Êñá‰ª∂‰∏çÂ≠òÂú®ÔºåË∑≥Ëøá: {yaml_file}")
        continue

    base = p.stem
    out = pathlib.Path("ruleset") / f"{base}.mrs"
    print(f"üî® ÊûÑÂª∫ {yaml_file} -> {out}")

    subprocess.check_call([mihomo, "convert-ruleset", "domain", "yaml", str(p), str(out)])
PY
        env:
          JSON: ${{ steps.changed-files.outputs.changed }}

      # ------------------------------------------------------------
      # Commit & push only if ruleset/ has staged changes
      # ------------------------------------------------------------
      - name: Commit & push
        shell: bash
        run: |
          set -euo pipefail

          git add ruleset/

          # Only commit when ruleset/ actually changed
          if git diff --cached --quiet; then
            echo "‚úÖ ruleset/ Ê≤°ÊúâÂèòÂåñÔºåÊó†ÈúÄÊèê‰∫§"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "build: update MRS files"
          git push
