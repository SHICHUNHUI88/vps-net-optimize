name: Build douyin.mrs

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Download mihomo
        shell: bash
        run: |
          set -euo pipefail
          # GitHub Runner æ˜¯ amd64ï¼Œç›´æ¥ä¸‹ amd64 ç‰ˆæœ¬å°±è¡Œ
          url="https://github.com/MetaCubeX/mihomo/releases/latest/download/mihomo-linux-amd64"
          echo "ğŸ“¥ Downloading: $url"
          curl -fL --retry 3 --retry-delay 2 "$url" -o mihomo
          chmod +x mihomo
          echo "âœ… mihomo version:"
          ./mihomo -v

      - name: Convert douyin.yaml -> douyin.mrs
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ruleset-mrs
          # douyin.yaml æ˜¯åŸŸåç±»è§„åˆ™ï¼Œç”¨ domain æ¨¡å¼
          ./mihomo convert-ruleset domain yaml ruleset-src/douyin.yaml ruleset-mrs/douyin.mrs

      - name: Commit douyin.mrs
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git status --porcelain | grep -q "ruleset-mrs/douyin.mrs"; then
            echo "ğŸ“¤ æäº¤ douyin.mrs..."
            git add ruleset-mrs/douyin.mrs
            git commit -m "build: update douyin.mrs" || exit 0
            git push
            echo "âœ… æ¨é€æˆåŠŸ"
          else
            echo "âœ… æ²¡æœ‰å˜æ›´ï¼Œæ— éœ€æäº¤"
          fi