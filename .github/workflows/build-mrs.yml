name: build-mrs

on:
  push:
    paths:
      - "ruleset-src/**/*.yaml"
      - ".github/workflows/build-mrs.yml"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -eux
          sudo apt-get update -y
          sudo apt-get install -y curl jq gzip tar findutils

      - name: Download mihomo (robust)
        shell: bash
        env:
          MIHOMO_VERSION: "latest"   # å›ºå®šç‰ˆæœ¬å°±å†™ "1.19.20"
        run: |
          set -euxo pipefail

          mkdir -p /tmp/mihomo-bin
          cd /tmp/mihomo-bin

          if [ "$MIHOMO_VERSION" = "latest" ]; then
            api="https://api.github.com/repos/MetaCubeX/mihomo/releases/latest"
          else
            api="https://api.github.com/repos/MetaCubeX/mihomo/releases/tags/v${MIHOMO_VERSION}"
          fi

          echo "API: $api"

          url="$(curl -fsSL "$api" | jq -r '
            .assets[]
            | select(.name | test("linux-amd64"))
            | select(.name | test("\\.(gz|tar\\.gz)$"))
            | .browser_download_url
          ' | head -n 1)"

          echo "Download URL: ${url:-}"
          if [ -z "${url:-}" ]; then
            echo "âŒ æ‰¾ä¸åˆ° linux-amd64 èµ„äº§ï¼Œassetsï¼š"
            curl -fsSL "$api" | jq -r '.assets[].name'
            exit 1
          fi

          curl -fL --retry 3 --retry-delay 2 -o mihomo.pkg "$url"

          size="$(stat -c%s mihomo.pkg)"
          echo "Downloaded size: $size"
          if [ "$size" -lt 1000000 ]; then
            echo "âŒ æ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½ä¸æ˜¯äºŒè¿›åˆ¶ã€‚å‰200å­—èŠ‚ï¼š"
            head -c 200 mihomo.pkg || true
            exit 1
          fi

          if echo "$url" | grep -qE '\.tar\.gz$'; then
            tar -xzf mihomo.pkg
          else
            mv mihomo.pkg mihomo.gz
            gzip -t mihomo.gz
            gzip -d -f mihomo.gz
          fi

          # æ‰¾åˆ°è§£åŽ‹å‡ºæ¥çš„äºŒè¿›åˆ¶ï¼ˆé€šå¸¸å°±å« mihomoï¼‰
          bin="$(find . -maxdepth 1 -type f -size +5M | head -n 1 | sed 's|^\./||')"
          echo "Detected binary: ${bin:-}"
          if [ -z "${bin:-}" ]; then
            echo "âŒ è§£åŽ‹åŽæ²¡æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼š"
            ls -lah
            exit 1
          fi

          # å¦‚æžœä¸æ˜¯ mihomo æ‰æ”¹åï¼Œé¿å… mv mihomo mihomo æŠ¥é”™
          if [ "$bin" != "mihomo" ]; then
            mv -f "$bin" mihomo
          fi

          chmod +x mihomo
          mv -f mihomo /tmp/mihomo
          /tmp/mihomo -v

      - name: Build mrs for all yaml
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p ruleset

          while IFS= read -r -d '' yaml_file; do
            base="$(basename "$yaml_file" .yaml)"
            out="ruleset/${base}.mrs"
            echo "ðŸ”¨ $yaml_file -> $out"
            /tmp/mihomo convert-ruleset domain yaml "$yaml_file" "$out"
          done < <(find ruleset-src -type f -name '*.yaml' -print0)

      - name: Commit & push
        shell: bash
        run: |
          set -euxo pipefail
          git add ruleset/
          if git diff --cached --quiet; then
            echo "âœ… æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "build: update MRS files"
          git push
