name: build-mrs

on:
  push:
    paths:
      - "ruleset-src/**.yaml"
      - ".github/workflows/build-mrs.yml"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download mihomo (auto-detect asset)
        shell: bash
        run: |
          set -euo pipefail

          # 1) 取 latest release 的 assets 列表（用 python 解析，避免 jq/apt）
          python3 - <<'PY'
          import json, re, urllib.request

          api = "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest"
          req = urllib.request.Request(api, headers={"User-Agent": "github-actions"})
          data = json.load(urllib.request.urlopen(req))

          assets = data.get("assets", [])
          # 允许 .gz 或 .tar.gz（两者选一个存在的）
          pat = re.compile(r"mihomo-linux-amd64\.(tar\.gz|gz)$")

          url = ""
          for a in assets:
              name = a.get("name","")
              if pat.search(name):
                  url = a.get("browser_download_url","")
                  break

          if not url:
              raise SystemExit("No matching asset found in latest release assets!")

          print(url)
          PY

          URL="$(python3 - <<'PY'
          import json, re, urllib.request
          api="https://api.github.com/repos/MetaCubeX/mihomo/releases/latest"
          req=urllib.request.Request(api, headers={"User-Agent":"github-actions"})
          data=json.load(urllib.request.urlopen(req))
          pat=re.compile(r"mihomo-linux-amd64\.(tar\.gz|gz)$")
          for a in data.get("assets", []):
              n=a.get("name","")
              if pat.search(n):
                  print(a.get("browser_download_url",""))
                  break
          PY
          )"

          echo "Download URL: $URL"

          # 2) 下载：-f 让 404 直接失败（不会再下到 9 字节）
          curl -fL --retry 3 --retry-delay 2 -o mihomo.pkg "$URL"

          # 3) 简单校验：文件太小直接判失败
          SIZE=$(stat -c%s mihomo.pkg)
          echo "Downloaded size: $SIZE bytes"
          if [ "$SIZE" -lt 1000000 ]; then
            echo "File too small, likely not a real binary package."
            head -c 200 mihomo.pkg || true
            exit 1
          fi

          # 4) 解包：tar.gz 或 gz
          if echo "$URL" | grep -qE '\.tar\.gz$'; then
            tar -xzf mihomo.pkg
          else
            mv mihomo.pkg mihomo.gz
            gunzip -f mihomo.gz
          fi

          chmod +x mihomo
          ./mihomo -v

      - name: Build mrs
        run: |
          set -eux
          mkdir -p ruleset
          ./mihomo convert-ruleset domain yaml ruleset-src/douyin.yaml ruleset/douyin.mrs

      - name: Commit & push
        run: |
          set -eux
          if git status --porcelain | grep -q .; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add ruleset/douyin.mrs
            git commit -m "build: update douyin.mrs"
            git push
          else
            echo "No changes."
          fi
