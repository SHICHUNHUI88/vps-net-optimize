name: build-mrs

on:
  push:
    paths:
      - "ruleset-src/**/*.yaml"
      - ".github/workflows/build-mrs.yml"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -eux
          sudo apt-get update -y
          sudo apt-get install -y curl gzip findutils

      - name: Download mihomo (robust)
        shell: bash
        env:
          MIHOMO_VERSION: "1.19.10"   # 你要固定哪个版本就改这里，比如 1.19.20
        run: |
          set -euxo pipefail

          mkdir -p /tmp/mihomo-bin
          cd /tmp/mihomo-bin

          url="https://github.com/MetaCubeX/mihomo/releases/download/v${MIHOMO_VERSION}/mihomo-linux-amd64.gz"
          echo "Downloading: $url"

          # 下载（失败就直接退出）
          curl -fL --retry 3 --retry-delay 2 -o mihomo.gz "$url"

          # 校验是不是 gzip（如果是 HTML/404，这里会立刻报错）
          gzip -t mihomo.gz || { echo "❌ Not a valid gzip. First 200 bytes:"; head -c 200 mihomo.gz; exit 1; }

          # 解压
          gzip -d -f mihomo.gz

          # 自动找到解压出来的二进制（通常 > 5MB）
          bin="$(find . -maxdepth 1 -type f -size +5M | head -n 1 | sed 's|^\./||')"
          if [ -z "${bin:-}" ]; then
            echo "❌ Cannot find extracted binary in /tmp/mihomo-bin"
            ls -lah
            exit 1
          fi

          # 统一命名为 mihomo
          if [ "$bin" != "mihomo" ]; then
            mv -f "$bin" mihomo
          fi

          chmod +x mihomo
          ./mihomo -v

      - name: Build mrs for all yaml
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p ruleset

          # 全量生成（你说你会改很多文件，干脆每次都全量最稳）
          for yaml_file in $(find ruleset-src -type f -name "*.yaml" | sort); do
            base="$(basename "$yaml_file" .yaml)"
            out="ruleset/${base}.mrs"
            echo "Build: $yaml_file -> $out"
            /tmp/mihomo-bin/mihomo convert-ruleset domain yaml "$yaml_file" "$out"
          done

      - name: Commit & push (only ruleset/)
        shell: bash
        run: |
          set -euxo pipefail

          git add ruleset/

          if git diff --cached --quiet; then
            echo "✅ No changes, skip commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "build: update MRS files"
          git push
