name: Build MRS (all ruleset-src)

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "ruleset-src/**.yaml"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Download mihomo
        shell: bash
        run: |
          set -euo pipefail
          arch="$(uname -m)"
          case "$arch" in
            x86_64)  asset="mihomo-linux-amd64" ;;
            aarch64) asset="mihomo-linux-arm64" ;;
            *) echo "Unsupported arch: $arch" && exit 1 ;;
          esac
          url="https://github.com/MetaCubeX/mihomo/releases/latest/download/${asset}"
          echo "ğŸ“¥ ä¸‹è½½ mihomo from: $url"
          curl -fL --retry 3 --retry-delay 2 "$url" -o mihomo
          chmod +x mihomo
          echo "âœ… mihomo ç‰ˆæœ¬ä¿¡æ¯:"
          ./mihomo -v

      - name: Build *.mrs from ruleset-src
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ruleset-mrs
          
          # ç»Ÿè®¡ä¿¡æ¯
          total=0
          converted=0
          failed=0
          
          echo "=========================================="
          echo "ğŸ”„ å¼€å§‹è½¬æ¢ YAML åˆ° MRS æ ¼å¼"
          echo "=========================================="

          shopt -s nullglob
          for f in ruleset-src/*.yaml; do
            base="$(basename "$f" .yaml)"
            out="ruleset-mrs/${base}.mrs"
            
            # é»˜è®¤ domainï¼›æ–‡ä»¶åä»¥ -ip ç»“å°¾å°±ç”¨ ipcidr
            kind="domain"
            if [[ "$base" == *-ip ]]; then
              kind="ipcidr"
            fi
            
            total=$((total + 1))
            
            # æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f "$f" ]; then
              echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $f"
              failed=$((failed + 1))
              continue
            fi
            
            # ç»Ÿè®¡è§„åˆ™æ•°é‡
            rule_count=$(grep -c "^  - " "$f" || echo "0")
            
            echo ""
            echo "ğŸ“ è½¬æ¢ [$total]: $base"
            echo "   è¾“å…¥: $f (è§„åˆ™æ•°: $rule_count)"
            echo "   è¾“å‡º: $out"
            echo "   ç±»å‹: $kind"
            
            # æ‰§è¡Œè½¬æ¢
            if ./mihomo convert-ruleset "$kind" yaml "$f" "$out" 2>&1; then
              converted=$((converted + 1))
              
              # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶å¤§å°
              if [ -f "$out" ]; then
                size=$(du -h "$out" | cut -f1)
                echo "   âœ… æˆåŠŸ (æ–‡ä»¶å¤§å°: $size)"
              else
                echo "   âš ï¸  è½¬æ¢è¾“å‡ºæ–‡ä»¶ä¸ºç©º"
                failed=$((failed + 1))
              fi
            else
              echo "   âŒ è½¬æ¢å¤±è´¥"
              failed=$((failed + 1))
            fi
          done
          
          echo ""
          echo "=========================================="
          echo "ğŸ“Š è½¬æ¢ç»Ÿè®¡"
          echo "=========================================="
          echo "æ€»æ–‡ä»¶æ•°: $total"
          echo "æˆåŠŸè½¬æ¢: $converted"
          echo "è½¬æ¢å¤±è´¥: $failed"
          
          if [ $failed -eq 0 ] && [ $converted -gt 0 ]; then
            echo "âœ… å…¨éƒ¨è½¬æ¢æˆåŠŸï¼"
          elif [ $converted -gt 0 ]; then
            echo "âš ï¸  éƒ¨åˆ†æ–‡ä»¶è½¬æ¢å¤±è´¥"
            exit 1
          else
            echo "âŒ æ²¡æœ‰æˆåŠŸè½¬æ¢ä»»ä½•æ–‡ä»¶"
            exit 1
          fi

      - name: List generated MRS files
        shell: bash
        run: |
          echo "ğŸ“¦ ç”Ÿæˆçš„ MRS æ–‡ä»¶åˆ—è¡¨:"
          ls -lh ruleset-mrs/*.mrs 2>/dev/null || echo "  (æš‚æ— æ–‡ä»¶)"

      - name: Commit results
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet --exit-code ruleset-mrs/; then
            echo "âœ… æ²¡æœ‰æ–°çš„å˜æ›´ï¼Œæ— éœ€æäº¤"
            exit 0
          fi
          
          echo "ğŸ“¤ æäº¤æ›´æ”¹..."
          git add ruleset-mrs/*.mrs
          git commit -m "build: update mrs files 2026-02-14 02:20:55" || exit 0
          git push
          echo "âœ… æ¨é€æˆåŠŸ"