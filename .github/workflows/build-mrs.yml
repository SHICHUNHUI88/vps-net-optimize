name: Build MRS (from ruleset-src)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * *" # UTC 04:00 = 北京时间 12:00

permissions:
  contents: write

env:
  MIHOMO_VERSION: "1.19.3"
  TOOLS_DIR: "data/tools"
  SRC_DIR: "ruleset-src"
  OUT_DIR: "ruleset-mrs"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml -q

      - name: Prepare dirs
        run: |
          mkdir -p "${{ env.TOOLS_DIR }}" "${{ env.OUT_DIR }}"

      - name: Download mihomo
        run: |
          set -e
          cd "${{ env.TOOLS_DIR }}"
          if [ ! -f mihomo ]; then
            echo "Downloading mihomo v${{ env.MIHOMO_VERSION }}..."
            wget -q --timeout=30 "https://github.com/MetaCubeX/mihomo/releases/download/v${{ env.MIHOMO_VERSION }}/mihomo-linux-amd64-v${{ env.MIHOMO_VERSION }}.gz"
            gzip -d "mihomo-linux-amd64-v${{ env.MIHOMO_VERSION }}.gz"
            mv "mihomo-linux-amd64-v${{ env.MIHOMO_VERSION }}" mihomo
            chmod +x mihomo
          fi
          cd - >/dev/null
          "${{ env.TOOLS_DIR }}/mihomo" -v || true

      - name: Convert ruleset-src YAML -> MRS
        run: |
          set -euo pipefail

          python - <<'PY'
          import os, pathlib, yaml

          SRC_DIR = pathlib.Path(os.environ["SRC_DIR"])
          OUT_DIR = pathlib.Path(os.environ["OUT_DIR"])
          TMP_DIR = OUT_DIR / ".tmp_domain_yaml"
          TMP_DIR.mkdir(parents=True, exist_ok=True)
          OUT_DIR.mkdir(parents=True, exist_ok=True)

          supported = {"DOMAIN", "DOMAIN-SUFFIX", "DOMAIN-WILDCARD"}

          def to_domain_line(rule: str):
            parts = [p.strip() for p in rule.split(",")]
            if len(parts) < 2:
              return None
            t = parts[0].upper()
            v = parts[1]
            if t not in supported:
              return None
            if t == "DOMAIN":
              return v
            if t == "DOMAIN-SUFFIX":
              return "." + v.lstrip(".")
            if t == "DOMAIN-WILDCARD":
              return v
            return None

          files = sorted(SRC_DIR.glob("*.yaml"))
          if not files:
            raise SystemExit(f"No yaml files found in {SRC_DIR}")

          for f in files:
            data = yaml.safe_load(f.read_text(encoding="utf-8")) or {}
            payload = data.get("payload", [])
            out = []
            if isinstance(payload, list):
              for item in payload:
                if isinstance(item, str):
                  r = to_domain_line(item)
                  if r:
                    out.append(r)

            domain_yaml = TMP_DIR / f.name  # 临时 domain 规则集
            domain_yaml.write_text(
              yaml.safe_dump({"payload": out}, allow_unicode=True, sort_keys=False),
              encoding="utf-8",
            )

            # 输出 mrs 文件名：与源文件同名
            mrs_path = OUT_DIR / (f.stem + ".mrs")
            print(f"[OK] {f.name}: {len(payload)} -> {len(out)} domain entries, mrs => {mrs_path}")
          PY

          count=0
          for domain_yaml in "${{ env.OUT_DIR }}/.tmp_domain_yaml/"*.yaml; do
            [ -f "$domain_yaml" ] || continue
            base="$(basename "$domain_yaml" .yaml)"
            out="${{ env.OUT_DIR }}/${base}.mrs"
            "${{ env.TOOLS_DIR }}/mihomo" convert-ruleset domain yaml "$domain_yaml" "$out"
            count=$((count+1))
          done
          echo "✓ Converted ${count} file(s) to MRS"

      - name: Cleanup temp
        run: |
          rm -rf "${{ env.OUT_DIR }}/.tmp_domain_yaml" || true

      - name: Commit & push if changed
        run: |
          set -e
          git add "${{ env.OUT_DIR }}" "${{ env.TOOLS_DIR }}/mihomo" || true
          if git diff --staged --quiet; then
            echo "No changes"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: update mrs $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push