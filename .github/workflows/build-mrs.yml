name: Build MRS (all ruleset-src)

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "ruleset-src/**.yaml"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Download mihomo
        shell: bash
        run: |
          set -euo pipefail
          arch="$(uname -m)"
          case "$arch" in
            x86_64)  asset="mihomo-linux-amd64" ;;
            aarch64) asset="mihomo-linux-arm64" ;;
            *) echo "Unsupported arch: $arch" && exit 1 ;;
          esac
          url="https://github.com/MetaCubeX/mihomo/releases/latest/download/${asset}"
          curl -fL --retry 3 --retry-delay 2 "$url" -o mihomo
          chmod +x mihomo
          ./mihomo -v

      - name: Build *.mrs from ruleset-src
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ruleset-mrs

          shopt -s nullglob
          for f in ruleset-src/*.yaml; do
            base="$(basename "$f" .yaml)"
            out="ruleset-mrs/${base}.mrs"

            # 默认 domain；文件名以 -ip 结尾就用 ipcidr（你以后有 IP 规则时用得上）
            kind="domain"
            if [[ "$base" == *-ip ]]; then
              kind="ipcidr"
            fi

            echo "Convert: $f -> $out (kind=$kind)"
            ./mihomo convert-ruleset "$kind" yaml "$f" "$out"
          done

      - name: Commit results
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add ruleset-mrs/*.mrs
          git commit -m "build: update mrs" || exit 0
          git push