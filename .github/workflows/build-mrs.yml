name: Build MRS (all ruleset-src)

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "ruleset-src/**/*.yaml"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # æ‹‰ä»£ç 
      - name: Checkout
        uses: actions/checkout@v5

      # æ—¶é—´æˆ³ï¼ˆç»™ commit ç”¨ï¼‰
      - name: Set timestamp
        shell: bash
        run: |
          set -euo pipefail
          echo "TS=$(date +%Y%m%d%H%M%S)" >> "$GITHUB_ENV"

      # âœ… è¿™æ˜¯ä½ è¦çš„ã€ŒDownload mihomoã€å®Œæ•´è„šæœ¬ï¼ˆä¸ä¼šå† mv è‡ªå·±ï¼‰
      - name: Download mihomo
        shell: bash
        run: |
          set -euo pipefail

          arch="$(uname -m)"
          case "$arch" in
            x86_64)        asset="mihomo-linux-amd64" ;;
            aarch64|arm64) asset="mihomo-linux-arm64" ;;
            *)
              echo "Unsupported arch: $arch"
              exit 1
              ;;
          esac

          url="https://github.com/MetaCubeX/mihomo/releases/latest/download/${asset}"
          echo "ğŸ“¥ ä¸‹è½½ mihomo from: $url"

          # ç›´æ¥ä¸‹è½½æˆ mihomoï¼Œä¸åšä»»ä½•â€œè‡ªåŠ¨æ£€æµ‹/é‡å‘½åâ€
          curl -fL --retry 3 --retry-delay 2 "$url" -o mihomo
          chmod +x mihomo

          echo "âœ… mihomo ç‰ˆæœ¬ä¿¡æ¯:"
          ./mihomo -v

      # æŠŠ ruleset-src é‡Œçš„ yaml æ‰¹é‡è½¬æˆ mrs
      - name: Build *.mrs from ruleset-src
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p ruleset-mrs

          echo "=========================================="
          echo "ğŸ”„ å¼€å§‹è½¬æ¢ YAML -> MRS"
          echo "=========================================="

          # æ‰¾å‡ºæ‰€æœ‰ yamlï¼ˆåŒ…å«å­ç›®å½•ï¼‰
          mapfile -t files < <(find ruleset-src -type f -name "*.yaml" | sort)

          if [ "${#files[@]}" -eq 0 ]; then
            echo "âŒ ruleset-src ä¸‹æ²¡æœ‰æ‰¾åˆ°ä»»ä½• .yaml æ–‡ä»¶"
            exit 1
          fi

          total=0
          converted=0
          failed=0

          for f in "${files[@]}"; do
            rel="${f#ruleset-src/}"                 # ç›¸å¯¹è·¯å¾„
            base="$(basename "$f" .yaml)"          # ä¸å¸¦åç¼€å
            out_dir="ruleset-mrs/$(dirname "$rel")"
            out="${out_dir}/${base}.mrs"

            # é»˜è®¤æŒ‰ domainï¼›æ–‡ä»¶åä»¥ -ip ç»“å°¾å°±æŒ‰ ipcidr
            kind="domain"
            if [[ "$base" == *-ip ]]; then
              kind="ipcidr"
            fi

            total=$((total + 1))
            mkdir -p "$out_dir"

            echo ""
            echo "ğŸ“ è½¬æ¢ [$total]: $rel"
            echo "   è¾“å…¥: $f"
            echo "   è¾“å‡º: $out"
            echo "   ç±»å‹: $kind"

            log="convert-${base}.log"

            if ./mihomo convert-ruleset "$kind" yaml "$f" "$out" >"$log" 2>&1; then
              if [ -s "$out" ]; then
                converted=$((converted + 1))
                size=$(du -h "$out" | cut -f1)
                echo "   âœ… æˆåŠŸ (å¤§å°: $size)"
              else
                failed=$((failed + 1))
                echo "   âŒ å¤±è´¥ï¼šè¾“å‡ºæ–‡ä»¶ä¸ºç©º"
                echo "   ---- é”™è¯¯æ—¥å¿— ----"
                cat "$log" || true
                echo "   ------------------"
              fi
            else
              failed=$((failed + 1))
              echo "   âŒ è½¬æ¢å¤±è´¥"
              echo "   ---- é”™è¯¯æ—¥å¿— ----"
              cat "$log" || true
              echo "   ------------------"
            fi
          done

          echo ""
          echo "=========================================="
          echo "ğŸ“Š è½¬æ¢ç»Ÿè®¡"
          echo "=========================================="
          echo "æ€»æ–‡ä»¶æ•°: $total"
          echo "æˆåŠŸè½¬æ¢: $converted"
          echo "è½¬æ¢å¤±è´¥: $failed"

          if [ $failed -eq 0 ] && [ $converted -gt 0 ]; then
            echo "âœ… å…¨éƒ¨è½¬æ¢æˆåŠŸï¼"
          elif [ $converted -gt 0 ]; then
            echo "âš ï¸  éƒ¨åˆ†æ–‡ä»¶è½¬æ¢å¤±è´¥"
            exit 1
          else
            echo "âŒ æ²¡æœ‰æˆåŠŸè½¬æ¢ä»»ä½•æ–‡ä»¶"
            exit 1
          fi

      - name: List generated MRS files
        shell: bash
        run: |
          echo "ğŸ“¦ ç”Ÿæˆçš„ MRS æ–‡ä»¶åˆ—è¡¨:"
          find ruleset-mrs -type f -name "*.mrs" -print -exec ls -lh {} \; || echo "  (æš‚æ— æ–‡ä»¶)"

      - name: Commit results
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # æ²¡æœ‰ä»»ä½• mrs äº§ç‰©å°±ç›´æ¥å¤±è´¥
          if ! find ruleset-mrs -type f -name "*.mrs" | grep -q .; then
            echo "âŒ æ²¡æœ‰ä»»ä½• .mrs äº§ç‰©ï¼Œç»ˆæ­¢æäº¤"
            exit 1
          fi

          # å¦‚æœæ²¡æœ‰å˜æ›´å°±ä¸æäº¤
          if git status --porcelain | grep -q "ruleset-mrs"; then
            echo "ğŸ“¤ æäº¤æ›´æ”¹..."
            git add ruleset-mrs
            git commit -m "build: update mrs files ${{ env.TS }}" || exit 0
            git push
            echo "âœ… æ¨é€æˆåŠŸ"
          else
            echo "âœ… æ²¡æœ‰æ–°çš„å˜æ›´ï¼Œæ— éœ€æäº¤"
          fi